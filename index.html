<script>
  const SECRET_CODE = "30112024";

  const codeInput = document.getElementById("code");
  const unlockBtn = document.getElementById("unlock-btn");
  const errorMsg = document.getElementById("error");
  const lockScreen = document.getElementById("lock-screen");
  const cardScreen = document.getElementById("card-screen");

  function checkCode() {
    const value = (codeInput.value || "").trim();
    if (value === SECRET_CODE) {
      lockScreen.classList.remove("active");
      cardScreen.classList.add("active");
      setTimeout(initScratch, 100); // <-- espera a que todo cargue
    } else {
      errorMsg.textContent = "Ups, esa no es la fecha correcta ü•≤";
      setTimeout(() => { errorMsg.textContent = ""; }, 2000);
    }
  }

  unlockBtn.addEventListener("click", checkCode);
  codeInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") checkCode();
  });

  // ‚≠ê FIX FINAL DEL SCRATCH ‚≠ê
  function initScratch() {
    const canvas = document.getElementById("scratch-canvas");
    const ctx = canvas.getContext("2d");
    const qrImg = document.querySelector(".scratch-wrapper img");

    // FORZAMOS A ESPERAR LA IMAGEN DEL QR
    if (!qrImg.complete) {
      qrImg.onload = () => initScratch();
      return;
    }

    // Ajustar tama√±o del canvas
    const rect = qrImg.getBoundingClientRect();
    canvas.width = rect.width;
    canvas.height = rect.height;

    // Pintar la capa a raspar
    ctx.globalCompositeOperation = "source-over";
    const grad = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
    grad.addColorStop(0, "#d8c1ff");
    grad.addColorStop(1, "#ffb6d1");
    ctx.fillStyle = grad;
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    ctx.fillStyle = "rgba(255, 255, 255, 0.6)";
    ctx.font = "bold 18px system-ui";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText("raspa aqu√≠ ‚ú®", canvas.width / 2, canvas.height / 2);

    let isDrawing = false;

    function getPos(e) {
      const bounds = canvas.getBoundingClientRect();
      if (e.touches) {
        return {
          x: e.touches[0].clientX - bounds.left,
          y: e.touches[0].clientY - bounds.top
        };
      }
      return {
        x: e.clientX - bounds.left,
        y: e.clientY - bounds.top
      };
    }

    function start(e) {
      e.preventDefault();
      isDrawing = true;
    }

    function end(e) {
      if (e) e.preventDefault();
      isDrawing = false;
    }

    function scratch(e) {
      if (!isDrawing) return;
      e.preventDefault();
      const pos = getPos(e);
      ctx.globalCompositeOperation = "destination-out";
      ctx.beginPath();
      ctx.arc(pos.x, pos.y, 20, 0, Math.PI * 2);
      ctx.fill();
    }

    canvas.addEventListener("mousedown", start);
    canvas.addEventListener("mousemove", scratch);
    canvas.addEventListener("mouseup", end);
    canvas.addEventListener("mouseleave", end);

    canvas.addEventListener("touchstart", start, { passive: false });
    canvas.addEventListener("touchmove", scratch, { passive: false });
    canvas.addEventListener("touchend", end, { passive: false });
  }
</script>
